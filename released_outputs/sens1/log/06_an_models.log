-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/sens1/log\06_an_mod
> els.log
  log type:  text
 opened on:  19 Aug 2020, 17:20:23

. 
. * Open Stata dataset
. use $Tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Main Model================================================================
> =*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure, nolog

         failure _d:  onsnoncoviddeath
   analysis time _t:  (stime_onsnoncoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Cox regression -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =        2,003
Time at risk    =   25636621.5
                                                LR chi2(1)       =       28.67
Log likelihood  =    -24347.56                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .7005092   .0487285    -5.12   0.000     .6112276    .8028322
------------------------------------------------------------------------------

. estimates save $Tempdir/univar, replace 
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/univar.ster 
> saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_univar
> _$outcome", replace) idstr("parmest_univar_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/parmest_univ
> ar_onsnoncoviddeath.dta saved

. 
. 
. /* Multivariable models */ 
. 
. * Age and Sex 
. * Age fit as spline 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onsnoncoviddeath
   analysis time _t:  (stime_onsnoncoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -24361.893
Iteration 1:   log likelihood = -23209.477
Iteration 2:   log likelihood = -22997.781
Iteration 3:   log likelihood = -22984.572
Iteration 4:   log likelihood = -22983.074
Iteration 5:   log likelihood = -22983.023
Iteration 6:   log likelihood = -22983.022
Refining estimates:
Iteration 0:   log likelihood = -22983.022

Cox regression -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =        2,003
Time at risk    =   25636621.5
                                                LR chi2(5)       =     2757.74
Log likelihood  =   -22983.022                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .9994149   .0700884    -0.01   0.993     .8710669    1.146674
      1.male |   1.244853   .0590071     4.62   0.000     1.134411    1.366048
        age1 |   1.061167   .0187132     3.37   0.001     1.025116    1.098485
        age2 |   1.039349   .0270178     1.48   0.138     .9877214    1.093675
        age3 |    .919096   .0914212    -0.85   0.396     .7562981    1.116937
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar1, replace 
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/multivar1.st
> er saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar1_$outcome", replace) idstr("parmest_multivar1_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/parmest_mult
> ivar1_onsnoncoviddeath.dta saved

. 
. 
. *recode unknown ethnicity to missing
. recode ethnicity .u=.
(ethnicity: 45328 changes made)

. *mi set the data (aka stset) 
. mi set mlong

. *mi register (tell Stata which variable to impute)
. mi register imputed ethnicity
(45328 m=0 obs. now marked as incomplete)

. *mi impute the dataset
. mi impute mlogit ethnicity i.exposure _d i.population i.stp i.male age1 age2 
> age3 i.dmard_pc i.oral_prednisolone i.nsaids i.chronic_cardiac_disease i.resp
> _excl_asthma i.egfr_cat_nomiss i.chronic_liver_disease i.obese4cat i.hyperten
> sion i.cancer_ever i.neuro_conditions i.flu_vaccine i.imd i.diabcat i.smoke_n
> omiss, add(10) rseed(8675309) augment

Univariate imputation                       Imputations =       10
Augmented multinomial logit regression            added =       10
Imputed: m=1 through m=10                       updated =        0

------------------------------------------------------------------
                   |               Observations per m             
                   |----------------------------------------------
          Variable |   Complete   Incomplete   Imputed |     Total
-------------------+-----------------------------------+----------
         ethnicity |     149309        45328     45328 |    194637
------------------------------------------------------------------
(complete + incomplete = total; imputed is the minimum across m
 of the number of filled-in observations.)

. *mi stset
. mi stset stime_$outcome, fail($outcome) id(patient_id) enter(enter_date) orig
> in(enter_date)     

                id:  patient_id
     failure event:  onsnoncoviddeath != 0 & onsnoncoviddeath < .
obs. time interval:  (stime_onsnoncoviddeath[_n-1], stime_onsnoncoviddeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    194,637  total observations
          0  exclusions
------------------------------------------------------------------------------
    194,637  observations remaining, representing
    194,637  subjects
      2,003  failures in single-failure-per-subject data
 25636621.5  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       134

.  * DAG adjusted (age, sex, ethnicity, geographic region, other immunosuppress
> ives (will include biologics when we have them))  
. *eform doesnt allow for lincom to build tables. use post
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 i.ethnicity i.
> dmard_pc i.oral_prednisolone, strata(stp population)                         
>       

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =    194,637
                                                Average RVI       =     0.1178
                                                Largest FMI       =     0.3600
DF adjustment:   Large sample                   DF:     min       =      76.30
                                                        avg       =   3.11e+09
                                                        max       =   1.23e+10
Model F test:       Equal FMI                   F(  11, 8252.2)   =     205.83
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0029667   .0708709     0.04   0.967    -.1359377    .1418711
      1.male |   .2215161   .0475775     4.66   0.000      .128266    .3147662
        age1 |   .0597357   .0176121     3.39   0.001     .0252166    .0942548
        age2 |   .0318109   .0259712     1.22   0.221    -.0190917    .0827135
        age3 |  -.0582148   .0995253    -0.58   0.559    -.2532807    .1368511
             |
   ethnicity |
South Asian  |  -.3244981   .1642316    -1.98   0.050    -.6485674   -.0004288
      Black  |  -.3641502   .2813986    -1.29   0.197    -.9180739    .1897735
      Mixed  |   .0945545   .4291366     0.22   0.826    -.7600912    .9492001
      Other  |   -.172373   .3656102    -0.47   0.638    -.8931439     .548398
             |
  1.dmard_pc |  -.3950997    .051044    -7.74   0.000     -.495144   -.2950553
1.oral_pr~ne |   .7068684   .0475539    14.86   0.000     .6136645    .8000724
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar2_mi, replace 
(note: file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/multi
> var2_mi.ster not found)
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/multivar2_mi
> .ster saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar2_mi_$outcome", replace) idstr("parmest_multivar2_mi_$outcome") 
(note: file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/parme
> st_multivar2_mi_onsnoncoviddeath.dta not found)
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/parmest_mult
> ivar2_mi_onsnoncoviddeath.dta saved

. 
. * DAG+ other adjustments (NSAIDs, heart disease, lung disease, kidney disease
> , liver disease, BMI, hypertension, cancer, stroke, dementia, and respiratory
>  disease excl asthma (OCS capturing ashtma))
. 
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 i.ethnicity i.
> dmard_pc i.oral_prednisolone i.nsaids i.chronic_cardiac_disease i.resp_excl_a
> sthma i.egfr_cat_nomiss i.chronic_liver_disease i.obese4cat i.hypertension i.
> cancer_ever i.neuro_conditions i.flu_vaccine i.imd i.diabcat i.smoke_nomiss, 
> strata(stp population)      

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =    194,637
                                                Average RVI       =     0.0422
                                                Largest FMI       =     0.3868
DF adjustment:   Large sample                   DF:     min       =      66.25
                                                        avg       =   2.21e+09
                                                        max       =   2.08e+10
Model F test:       Equal FMI                   F(  33,176610.5)  =     101.38
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0168609   .0710088     0.24   0.812    -.1223138    .1560357
      1.male |   .0510717   .0492072     1.04   0.299    -.0453727     .147516
        age1 |   .0558985   .0176767     3.16   0.002     .0212527    .0905442
        age2 |   .0203638   .0261737     0.78   0.437    -.0309358    .0716633
        age3 |  -.0072326   .1005522    -0.07   0.943    -.2043114    .1898462
             |
   ethnicity |
South Asian  |  -.2989253   .1665608    -1.79   0.074    -.6275028    .0296521
      Black  |  -.4111649    .282948    -1.45   0.147    -.9682546    .1459248
      Mixed  |   .0679959   .4384968     0.16   0.877    -.8074294    .9434212
      Other  |  -.1914143   .3705527    -0.52   0.606    -.9227379    .5399094
             |
  1.dmard_pc |  -.2583134   .0516077    -5.01   0.000    -.3594626   -.1571642
1.oral_pr~ne |   .5379874   .0492206    10.93   0.000     .4415167    .6344581
    1.nsaids |   -.029076   .0833857    -0.35   0.727    -.1925091     .134357
1.~c_disease |   .4803145   .0487408     9.85   0.000     .3847843    .5758447
1.resp_exc~a |   .4124297   .0519603     7.94   0.000     .3105893      .51427
             |
egfr_cat_n~s |
      30-59  |   .0524626   .0533386     0.98   0.325    -.0520791    .1570044
        <30  |   .8530126   .0944369     9.03   0.000     .6679196    1.038106
             |
1.~r_disease |   .6559088   .1366928     4.80   0.000     .3879958    .9238218
             |
   obese4cat |
Obese I ..)  |  -.3912846   .0705248    -5.55   0.000    -.5295106   -.2530586
Obese II..)  |  -.1330973   .1012158    -1.31   0.189    -.3314766    .0652821
Obese II..)  |   .0235463    .144029     0.16   0.870    -.2587453    .3058379
             |
1.hyperten~n |   .0481951   .0510615     0.94   0.345    -.0518837    .1482738
1.cancer_e~r |   .7500637   .0498977    15.03   0.000      .652266    .8478614
1.neuro_co~s |   .5350236   .0563354     9.50   0.000     .4246082     .645439
1.flu_vacc~e |  -.2708399   .0540547    -5.01   0.000    -.3767851   -.1648947
             |
         imd |
          2  |   .1909753   .0741458     2.58   0.010     .0456523    .3362984
          3  |   .2521933     .07447     3.39   0.001     .1062347    .3981519
          4  |    .230725   .0762617     3.03   0.002     .0812549    .3801951
5 most de..  |   .4122132   .0764978     5.39   0.000     .2622803    .5621461
             |
     diabcat |
Controlle..  |   .1073439   .0613738     1.75   0.080    -.0129467    .2276344
Uncontrol..  |   .3584824   .0867039     4.13   0.000     .1885458    .5284191
Diabetes,..  |   .6214339   .1218886     5.10   0.000     .3825366    .8603312
             |
smoke_nomiss |
     Former  |   .1067267   .0535668     1.99   0.046     .0017372    .2117161
    Current  |   .5654752   .0798721     7.08   0.000     .4089284     .722022
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar3_mi, replace 
(note: file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/multi
> var3_mi.ster not found)
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/multivar3_mi
> .ster saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar3_mi_$outcome", replace) idstr("parmest_multivar3_mi_$outcome") 
(note: file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/parme
> st_multivar3_mi_onsnoncoviddeath.dta not found)
file E:\analyses\hydroxychloroquine-research/output/sens1/tempdata/parmest_mult
> ivar3_mi_onsnoncoviddeath.dta saved

. 
.  
. 
. 
. 
. * Open Stata dataset
. use $Tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Print table===============================================================
> =*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using $Tabfigdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between HCQ use and $tableoutc
> ome - IMPUTED ETHNICITY") _n

. file write tablecontent _tab ("N") _tab ("Univariable") _tab _tab ("Age/Sex A
> djusted") _tab _tab ///
>                                                 ("DAG Adjusted") _tab _tab ("
> Fully Adjusted") _tab _tab  _n

. file write tablecontent _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab (
> "95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                 
>    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         cou if exposure == 0 
  164,068

.         local rowdenom = r(N)

.         cou if exposure == 0 & $outcome == 1
  1,769

.         local pct = 100*(r(N)/`rowdenom') 

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab 
> _tab ("1.00 (ref)")  _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (comparator)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         cou if exposure == 1 
  30,569

.         local rowdenom = r(N)

.         cou if exposure == 1 & $outcome == 1
  234

.         local pct = 100*(r(N)/`rowdenom') 

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

. 
. /* Main Model */ 
. estimates use $Tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7005092   .0487285    -5.12   0.000     .6112276    .8028322
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar1

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9994149   .0700884    -0.01   0.993     .8710669    1.146674
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar2_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.002971   .0710815     0.04   0.967      .872897    1.152428
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar3_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.017004   .0722163     0.24   0.812     .8848706    1.168868
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/sens1/log\06_an_mod
> els.log
  log type:  text
 closed on:  19 Aug 2020, 17:27:15
-------------------------------------------------------------------------------
