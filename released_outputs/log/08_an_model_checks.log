-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/log\08_an_model_che
> cks.log
  log type:  text
 opened on:  19 Aug 2020, 17:09:34

. 
. * Open Stata dataset
. use $Tempdir\analysis_dataset_STSET_$outcome, clear

. 
. * Exposure labels 
. local lab1: label exposure 1

. 
. /* Quietly run models, perform test and store results in local macro=========
> =*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.00822         0.04        1         0.8476
      ------------+---------------------------------------------------
      global test |                      0.04        1         0.8476
      ----------------------------------------------------------------

. local univar_p1 = round(r(phtest)[2,4],0.001)

. 
. di `univar_p1'
.848

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) /
> //
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, Univaria
> ble `lab1'", position(11) size(medsmall)) 

. 
. graph export "$Tabfigdir/schoenplot1a.svg", as(svg) replace
(file E:\analyses\hydroxychloroquine-research/output/tabfig/schoenplot1a.svg wr
> itten in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6653.2457
Iteration 1:   log likelihood = -6363.7842
Iteration 2:   log likelihood = -6299.4394
Iteration 3:   log likelihood = -6293.4165
Iteration 4:   log likelihood = -6292.6884
Iteration 5:   log likelihood = -6292.6429
Iteration 6:   log likelihood = -6292.6426
Refining estimates:
Iteration 0:   log likelihood = -6292.6426

Cox regression -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =          547
Time at risk    =   25636621.5
                                                LR chi2(5)       =      721.21
Log likelihood  =   -6292.6426                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   1.084274   .1398098     0.63   0.530     .8421363    1.396033
      1.male |   1.462889   .1293406     4.30   0.000     1.230135    1.739682
        age1 |   1.050966   .0377137     1.39   0.166     .9795883    1.127545
        age2 |   1.088567   .0570047     1.62   0.105     .9823821    1.206229
        age3 |   .7057895   .1409865    -1.74   0.081     .4771353     1.04402
------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.02003         0.22        1         0.6400
      0b.male     |            .            .        1             .
      1.male      |     -0.04760         1.24        1         0.2654
      age1        |     -0.04514         0.55        1         0.4570
      age2        |      0.02501         0.20        1         0.6550
      age3        |     -0.00385         0.01        1         0.9416
      ------------+---------------------------------------------------
      global test |                      8.81        5         0.1167
      ----------------------------------------------------------------

. local multivar1_p1 = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) /
> //
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, Age/Sex 
> Adjusted `lab1'", position(11) size(medsmall))                       

. 
. graph export "$Tabfigdir/schoenplot2a.svg", as(svg) replace
(file E:\analyses\hydroxychloroquine-research/output/tabfig/schoenplot2a.svg wr
> itten in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3 i.dmard_pc i.oral_prednisolone, strata
> (stp population)

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -4750.7712
Iteration 1:   log likelihood = -4661.9405
Iteration 2:   log likelihood = -4356.5691
Iteration 3:   log likelihood = -4348.3044
Iteration 4:   log likelihood = -4348.1268
Iteration 5:   log likelihood = -4348.1261
Iteration 6:   log likelihood = -4348.1261
Refining estimates:
Iteration 0:   log likelihood = -4348.1261

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =          547
Time at risk    =   25636621.5
                                                LR chi2(7)       =      805.29
Log likelihood  =   -4348.1261                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   1.030762   .1342742     0.23   0.816     .7984998    1.330582
      1.male |   1.463663   .1298619     4.29   0.000      1.23004    1.741658
        age1 |   1.054341   .0381702     1.46   0.144      .982121    1.131871
        age2 |   1.075026   .0566817     1.37   0.170     .9694799    1.192064
        age3 |   .7481172   .1504449    -1.44   0.149     .5044227    1.109544
  1.dmard_pc |   .9328877   .0860025    -0.75   0.451     .7786772    1.117638
1.oral_pr~ne |    2.46496   .2180972    10.20   0.000     2.072509    2.931726
------------------------------------------------------------------------------
                                                  Stratified by stp population

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.01533         0.13        1         0.7191
      0b.male     |            .            .        1             .
      1.male      |     -0.04555         1.14        1         0.2860
      age1        |     -0.04109         0.47        1         0.4948
      age2        |      0.02406         0.19        1         0.6664
      age3        |     -0.00394         0.01        1         0.9402
      0b.dmard_pc |            .            .        1             .
      1.dmard_pc  |     -0.02518         0.35        1         0.5531
      0b.oral_p~ne|            .            .        1             .
      1.oral_pr~ne|     -0.06131         2.07        1         0.1505
      ------------+---------------------------------------------------
      global test |                     11.71        7         0.1105
      ----------------------------------------------------------------

. local multivar2_p1 = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) /
> //
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) /// 
>                           title ("Schoenfeld residuals against time, DAG Adju
> sted `lab1'", position(11) size(medsmall))                   

.                           
. graph export "$Tabfigdir/schoenplot3a.svg", as(svg) replace
(file E:\analyses\hydroxychloroquine-research/output/tabfig/schoenplot3a.svg wr
> itten in SVG format)

. 
. * Close window 
. graph close

. 
. stcox i.exposure i.male age1 age2 age3 i.dmard_pc i.oral_prednisolone i.nsaid
> s i.chronic_cardiac_disease i.resp_excl_asthma i.egfr_cat_nomiss i.chronic_li
> ver_disease i.obese4cat i.hypertension i.cancer_ever i.neuro_conditions i.flu
> _vaccine i.imd i.diabcat i.smoke_nomiss, strata(stp population)

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -4750.7712
Iteration 1:   log likelihood = -4360.8939
Iteration 2:   log likelihood = -4285.2087
Iteration 3:   log likelihood = -4280.1234
Iteration 4:   log likelihood = -4279.5622
Iteration 5:   log likelihood = -4279.5335
Iteration 6:   log likelihood = -4279.5334
Refining estimates:
Iteration 0:   log likelihood = -4279.5334

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =          547
Time at risk    =   25636621.5
                                                LR chi2(29)      =      942.48
Log likelihood  =   -4279.5334                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   1.034054   .1349618     0.26   0.798     .8006575    1.335487
      1.male |   1.258393   .1156261     2.50   0.012     1.051004    1.506704
        age1 |   1.052019   .0385628     1.38   0.167     .9790888    1.130382
        age2 |   1.059931   .0566608     1.09   0.276     .9544976     1.17701
        age3 |   .7963206   .1623783    -1.12   0.264     .5339725    1.187564
  1.dmard_pc |   1.036379    .096697     0.38   0.702     .8631757    1.244337
1.oral_pr~ne |   2.152156   .1975333     8.35   0.000     1.797824    2.576323
    1.nsaids |   .8537185   .1406669    -0.96   0.337     .6181054    1.179144
1.~c_disease |   1.435714   .1337287     3.88   0.000     1.196144    1.723267
1.resp_exc~a |   1.341157   .1332016     2.96   0.003     1.103925     1.62937
             |
egfr_cat_n~s |
      30-59  |   1.158961   .1163171     1.47   0.142      .952005    1.410906
        <30  |   2.069124   .4114608     3.66   0.000      1.40126    3.055303
             |
1.~r_disease |   1.244417   .3992341     0.68   0.495      .663565    2.333719
             |
   obese4cat |
Obese I ..)  |   1.025825   .1199407     0.22   0.827     .8157362    1.290021
Obese II..)  |   1.186663   .2069047     0.98   0.326      .843166    1.670096
Obese II..)  |   1.330839   .3378622     1.13   0.260     .8091513    2.188877
             |
1.hyperten~n |   1.016488   .0993226     0.17   0.867     .8393244    1.231046
1.cancer_e~r |   1.269812   .1367922     2.22   0.027     1.028117    1.568326
1.neuro_co~s |   1.704294   .1868795     4.86   0.000     1.374701    2.112908
1.flu_vacc~e |   .8066862   .0854829    -2.03   0.043     .6553972    .9928982
             |
         imd |
          2  |   1.318217   .1911347     1.91   0.057     .9921263    1.751486
          3  |   1.521664   .2184706     2.92   0.003     1.148442    2.016178
          4  |   1.428828   .2109287     2.42   0.016     1.069849    1.908259
5 most de..  |   1.598354   .2397846     3.13   0.002     1.191176    2.144717
             |
     diabcat |
Controlle..  |   1.096914   .1261896     0.80   0.421     .8754878    1.374344
Uncontrol..  |   1.520751   .2379442     2.68   0.007     1.119115    2.066528
Diabetes,..  |   1.757608   .4165984     2.38   0.017     1.104499    2.796911
             |
smoke_nomiss |
     Former  |   1.419287   .1462231     3.40   0.001     1.159777    1.736864
    Current  |   1.131051   .2067267     0.67   0.500     .7905054    1.618303
------------------------------------------------------------------------------
                                                  Stratified by stp population

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.01689         0.16        1         0.6914
      0b.male     |            .            .        1             .
      1.male      |     -0.04320         1.02        1         0.3124
      age1        |     -0.03956         0.44        1         0.5071
      age2        |      0.02712         0.24        1         0.6230
      age3        |     -0.00846         0.03        1         0.8705
      0b.dmard_pc |            .            .        1             .
      1.dmard_pc  |     -0.01515         0.13        1         0.7226
      0b.oral_p~ne|            .            .        1             .
      1.oral_pr~ne|     -0.05931         1.96        1         0.1618
      0b.nsaids   |            .            .        1             .
      1.nsaids    |     -0.02513         0.33        1         0.5631
      0b.chronic..|            .            .        1             .
      1.~c_disease|     -0.01505         0.13        1         0.7203
      0b.resp_ex~a|            .            .        1             .
      1.resp_exc~a|     -0.00428         0.01        1         0.9199
      1b.egfr_ca~s|            .            .        1             .
      2.egfr_cat~s|      0.04667         1.29        1         0.2561
      3.egfr_cat~s|      0.02015         0.23        1         0.6305
      0b.chronic..|            .            .        1             .
      1.~r_disease|      0.04453         1.10        1         0.2953
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.01180         0.07        1         0.7857
      3.obese4cat |      0.01543         0.13        1         0.7173
      4.obese4cat |     -0.03469         0.64        1         0.4255
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.03596         0.70        1         0.4026
      0b.cancer_~r|            .            .        1             .
      1.cancer_e~r|      0.00178         0.00        1         0.9664
      0b.neuro_c~s|            .            .        1             .
      1.neuro_co~s|      0.03803         0.79        1         0.3743
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|     -0.02730         0.42        1         0.5167
      1b.imd      |            .            .        1             .
      2.imd       |      0.04784         1.25        1         0.2634
      3.imd       |      0.05116         1.43        1         0.2318
      4.imd       |      0.03768         0.77        1         0.3790
      5.imd       |      0.08104         3.58        1         0.0586
      1b.diabcat  |            .            .        1             .
      2.diabcat   |      0.04915         1.28        1         0.2584
      3.diabcat   |     -0.01654         0.15        1         0.7028
      4.diabcat   |     -0.05360         1.59        1         0.2071
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.00810         0.04        1         0.8505
      3.smoke_no~s|      0.08734         4.19        1         0.0407
      ------------+---------------------------------------------------
      global test |                     31.51       29         0.3418
      ----------------------------------------------------------------

. local multivar3_p1 = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) /
> //
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) /// 
>                           title ("Schoenfeld residuals against time, Fully Ad
> justed `lab1'", position(11) size(medsmall))                 

.                           
. graph export "$Tabfigdir/schoenplot4a.svg", as(svg) replace
(file E:\analyses\hydroxychloroquine-research/output/tabfig/schoenplot4a.svg wr
> itten in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results=====================================================
> =*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using $Tabfigdir/table4.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption for $tableoutcom
> e") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab /
> //
>                                                 ("DAG Adjusted") _tab ("Fully
>  Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _t
> ab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("`lab1'") _tab

. file write tablecontent ("`univar_p1'") _tab ("`multivar1_p1'") _tab ("`multi
> var2_p1'") _tab ("`multivar3_p1'") _n

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/log\08_an_model_che
> cks.log
  log type:  text
 closed on:  19 Aug 2020, 17:12:12
-------------------------------------------------------------------------------
