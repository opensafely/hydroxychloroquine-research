-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/log\06_an_models.lo
> g
  log type:  text
 opened on:   6 Oct 2020, 12:33:09

. 
. * Open Stata dataset
. use $Tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Main Model================================================================
> =*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure, nolog

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Cox regression -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =          547
Time at risk    =   25636621.5
                                                LR chi2(1)       =        4.13
Log likelihood  =   -6651.1805                  Prob > chi2      =      0.0421

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .7771215    .099466    -1.97   0.049     .6047017    .9987036
------------------------------------------------------------------------------

. estimates save $Tempdir/univar, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/univar.ster saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_univar
> _$outcome", replace) idstr("parmest_univar_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_univar_ons
> coviddeath.dta saved

. 
. 
. /* Multivariable models */ 
. 
. * Age and Sex 
. * Age fit as spline 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6653.2457
Iteration 1:   log likelihood = -6363.7842
Iteration 2:   log likelihood = -6299.4394
Iteration 3:   log likelihood = -6293.4165
Iteration 4:   log likelihood = -6292.6884
Iteration 5:   log likelihood = -6292.6429
Iteration 6:   log likelihood = -6292.6426
Refining estimates:
Iteration 0:   log likelihood = -6292.6426

Cox regression -- Breslow method for ties

No. of subjects =      194,637                  Number of obs    =     194,637
No. of failures =          547
Time at risk    =   25636621.5
                                                LR chi2(5)       =      721.21
Log likelihood  =   -6292.6426                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   1.084274   .1398098     0.63   0.530     .8421363    1.396033
      1.male |   1.462889   .1293406     4.30   0.000     1.230135    1.739682
        age1 |   1.050966   .0377137     1.39   0.166     .9795883    1.127545
        age2 |   1.088567   .0570047     1.62   0.105     .9823821    1.206229
        age3 |   .7057895   .1409865    -1.74   0.081     .4771353     1.04402
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar1, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/multivar1.ster sav
> ed

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar1_$outcome", replace) idstr("parmest_multivar1_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_multivar1_
> onscoviddeath.dta saved

. 
. 
. *recode unknown ethnicity to missing
. recode ethnicity .u=.
(ethnicity: 45328 changes made)

. *mi set the data (aka stset) 
. mi set mlong

. *mi register (tell Stata which variable to impute)
. mi register imputed ethnicity
(45328 m=0 obs. now marked as incomplete)

. *mi impute the dataset
. mi impute mlogit ethnicity i.exposure _d i.population i.stp i.male age1 age2 
> age3 i.dmard_pc i.oral_prednisolone i.nsaids i.chronic_cardiac_disease i.resp
> _excl_asthma i.egfr_cat_nomiss i.chronic_liver_disease i.obese4cat i.hyperten
> sion i.cancer_ever i.neuro_conditions i.flu_vaccine i.imd i.diabcat i.smoke_n
> omiss, add(10) rseed(8675309) augment force 

Univariate imputation                       Imputations =       10
Augmented multinomial logit regression            added =       10
Imputed: m=1 through m=10                       updated =        0

------------------------------------------------------------------
                   |               Observations per m             
                   |----------------------------------------------
          Variable |   Complete   Incomplete   Imputed |     Total
-------------------+-----------------------------------+----------
         ethnicity |     149309        45328     45328 |    194637
------------------------------------------------------------------
(complete + incomplete = total; imputed is the minimum across m
 of the number of filled-in observations.)

. *mi stset
. mi stset stime_$outcome, fail($outcome) id(patient_id) enter(enter_date) orig
> in(enter_date)     

                id:  patient_id
     failure event:  onscoviddeath != 0 & onscoviddeath < .
obs. time interval:  (stime_onscoviddeath[_n-1], stime_onscoviddeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    194,637  total observations
          0  exclusions
------------------------------------------------------------------------------
    194,637  observations remaining, representing
    194,637  subjects
        547  failures in single-failure-per-subject data
 25636621.5  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       134

. *save off MI dataset for later use
. save $Tempdir\analysis_dataset_STSET_mi_$outcome, replace
file E:\analyses\hydroxychloroquine-research/output/tempdata\analysis_dataset_S
> TSET_mi_onscoviddeath.dta saved

. 
. 
.  * DAG adjusted (age, sex, ethnicity, geographic region, other immunosuppress
> ives (will include biologics when we have them))  
. *eform doesnt allow for lincom to build tables. use post
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 i.ethnicity i.
> dmard_pc i.oral_prednisolone, strata(stp population)                         
>       

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =    194,637
                                                Average RVI       =     0.0803
                                                Largest FMI       =     0.2700
DF adjustment:   Large sample                   DF:     min       =     134.00
                                                        avg       =   1.12e+10
                                                        max       =   5.85e+10
Model F test:       Equal FMI                   F(  11,16571.4)   =      52.87
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0281135   .1302948     0.22   0.829    -.2272597    .2834866
      1.male |   .3826004   .0887523     4.31   0.000     .2086491    .5565517
        age1 |   .0531781    .036234     1.47   0.142    -.0178391    .1241954
        age2 |   .0723386   .0527415     1.37   0.170    -.0310329    .1757101
        age3 |  -.2910205   .2011476    -1.45   0.148    -.6852625    .1032216
             |
   ethnicity |
South Asian  |  -.0125093   .2574012    -0.05   0.961    -.5204154    .4953968
      Black  |   .2316284   .3765419     0.62   0.539    -.5097595    .9730164
      Mixed  |   .5428151   .6012981     0.90   0.368     -.646448    1.732078
      Other  |  -.5530832   .7148528    -0.77   0.439    -1.954475    .8483084
             |
  1.dmard_pc |  -.0685174   .0922335    -0.74   0.458    -.2492918    .1122571
1.oral_pr~ne |   .9016079   .0884826    10.19   0.000     .7281852    1.075031
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar2_mi, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/multivar2_mi.ster 
> saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar2_mi_$outcome", replace) idstr("parmest_multivar2_mi_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_multivar2_
> mi_onscoviddeath.dta saved

. 
. * DAG+ other adjustments (NSAIDs, heart disease, lung disease, kidney disease
> , liver disease, BMI, hypertension, cancer, stroke, dementia, and respiratory
>  disease excl asthma (OCS capturing ashtma))
. 
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 i.ethnicity i.
> dmard_pc i.oral_prednisolone i.nsaids i.chronic_cardiac_disease i.resp_excl_a
> sthma i.egfr_cat_nomiss i.chronic_liver_disease i.obese4cat i.hypertension i.
> cancer_ever i.neuro_conditions i.flu_vaccine i.imd i.diabcat i.smoke_nomiss, 
> strata(stp population)      

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =    194,637
                                                Average RVI       =     0.0284
                                                Largest FMI       =     0.2803
DF adjustment:   Large sample                   DF:     min       =     124.55
                                                        avg       =   5.51e+09
                                                        max       =   6.13e+10
Model F test:       Equal FMI                   F(  33,378885.5)  =      23.20
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0314376   .1305686     0.24   0.810    -.2244721    .2873472
      1.male |   .2309046   .0919484     2.51   0.012     .0506891    .4111202
        age1 |   .0509162   .0366881     1.39   0.165    -.0209911    .1228235
        age2 |   .0580942    .053474     1.09   0.277    -.0467129    .1629014
        age3 |  -.2278731   .2039527    -1.12   0.264     -.627613    .1718668
             |
   ethnicity |
South Asian  |  -.0045747   .2663461    -0.02   0.986    -.5306005     .521451
      Black  |   .1568677   .3809138     0.41   0.681    -.5934057    .9071411
      Mixed  |   .4225708   .6077925     0.70   0.488    -.7803689     1.62551
      Other  |  -.5415711   .7168897    -0.76   0.450    -1.947008    .8638661
             |
  1.dmard_pc |   .0358566   .0933208     0.38   0.701    -.1470487     .218762
1.oral_pr~ne |   .7650701   .0918089     8.33   0.000     .5851279    .9450123
    1.nsaids |  -.1576144   .1647751    -0.96   0.339    -.4805678    .1653389
1.~c_disease |   .3626024   .0931945     3.89   0.000     .1799446    .5452602
1.resp_exc~a |   .2940052   .0993961     2.96   0.003     .0991924     .488818
             |
egfr_cat_n~s |
      30-59  |   .1464689   .1003707     1.46   0.144    -.0502542    .3431919
        <30  |   .7227834   .1990542     3.63   0.000     .3326443    1.112922
             |
1.~r_disease |   .2267115   .3209158     0.71   0.480    -.4022719    .8556949
             |
   obese4cat |
Obese I ..)  |   .0230574   .1170095     0.20   0.844     -.206277    .2523917
Obese II..)  |   .1689883    .174563     0.97   0.333     -.173149    .5111256
Obese II..)  |   .2811138   .2541526     1.11   0.269    -.2170162    .7792438
             |
1.hyperten~n |   .0155003   .0977848     0.16   0.874    -.1761545    .2071551
1.cancer_e~r |   .2396665   .1078533     2.22   0.026     .0282778    .4510552
1.neuro_co~s |   .5327419   .1096697     4.86   0.000     .3177933    .7476905
1.flu_vacc~e |  -.2130999   .1060544    -2.01   0.045    -.4209627   -.0052371
             |
         imd |
          2  |   .2759002   .1449929     1.90   0.057    -.0082807     .560081
          3  |   .4194783    .143629     2.92   0.003     .1379707    .7009859
          4  |   .3553662   .1478779     2.40   0.016     .0655309    .6452015
5 most de..  |   .4646336   .1508519     3.08   0.002     .1689689    .7602982
             |
     diabcat |
Controlle..  |   .0915449   .1157982     0.79   0.429    -.1354158    .3185056
Uncontrol..  |    .415914   .1576961     2.64   0.008     .1068345    .7249936
Diabetes,..  |   .5634725   .2373303     2.37   0.018     .0983137    1.028631
             |
smoke_nomiss |
     Former  |   .3513423   .1049829     3.35   0.001     .1455772    .5571075
    Current  |   .1257589   .1847319     0.68   0.496    -.2363105    .4878282
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar3_mi, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/multivar3_mi.ster 
> saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar3_mi_$outcome", replace) idstr("parmest_multivar3_mi_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_multivar3_
> mi_onscoviddeath.dta saved

. 
.  
. 
. 
. 
. * Open Stata dataset
. use $Tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Print table===============================================================
> =*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using $Tabfigdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between HCQ use and $tableoutc
> ome - IMPUTED ETHNICITY") _n

. file write tablecontent _tab ("N") _tab ("Univariable") _tab _tab ("Age/Sex A
> djusted") _tab _tab ///
>                                                 ("DAG Adjusted") _tab _tab ("
> Fully Adjusted") _tab _tab  _n

. file write tablecontent _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab (
> "95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                 
>    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         cou if exposure == 0 
  164,068

.         local rowdenom = r(N)

.         cou if exposure == 0 & $outcome == 1
  477

.         local pct = 100*(r(N)/`rowdenom') 

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab 
> _tab ("1.00 (ref)")  _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (comparator)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         cou if exposure == 1 
  30,569

.         local rowdenom = r(N)

.         cou if exposure == 1 & $outcome == 1
  70

.         local pct = 100*(r(N)/`rowdenom') 

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

. 
. /* Main Model */ 
. estimates use $Tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7771215    .099466    -1.97   0.049     .6047017    .9987036
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar1

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.084274   .1398098     0.63   0.530     .8421363    1.396033
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar2_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.028512   .1340098     0.22   0.829     .7967139    1.327751
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar3_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.031937   .1347385     0.24   0.810     .7989379    1.332887
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/log\06_an_models.lo
> g
  log type:  text
 closed on:   6 Oct 2020, 12:40:56
-------------------------------------------------------------------------------
