-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/log\13_an_mi.log
  log type:  text
 opened on:  19 Aug 2020, 14:37:19

. 
. * Open Stata dataset
. use $Tempdir\analysis_dataset_STSET_$outcome, clear

. 
. *recode unknown ethnicity to missing
. recode ethnicity .u=.
(ethnicity: 45328 changes made)

. 
. *mi set the data (aka stset) 
. mi set mlong

. 
. *mi register (tell Stata which variable to impute)
. mi register imputed ethnicity
(45328 m=0 obs. now marked as incomplete)

. 
. *mi impute the dataset
. mi impute mlogit ethnicity, add(10) rseed(8675309)

Univariate imputation                       Imputations =       10
Multinomial logistic regression                   added =       10
Imputed: m=1 through m=10                       updated =        0

------------------------------------------------------------------
                   |               Observations per m             
                   |----------------------------------------------
          Variable |   Complete   Incomplete   Imputed |     Total
-------------------+-----------------------------------+----------
         ethnicity |     149309        45328     45328 |    194637
------------------------------------------------------------------
(complete + incomplete = total; imputed is the minimum across m
 of the number of filled-in observations.)

. 
. *mi stset
. mi      stset stime_$outcome, fail($outcome) id(patient_id) enter(enter_date)
>  origin(enter_date)        

                id:  patient_id
     failure event:  onscoviddeath != 0 & onscoviddeath < .
obs. time interval:  (stime_onscoviddeath[_n-1], stime_onscoviddeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    194,637  total observations
          0  exclusions
------------------------------------------------------------------------------
    194,637  observations remaining, representing
    194,637  subjects
        547  failures in single-failure-per-subject data
 25636621.5  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       134

.  
. /* Main Model================================================================
> =*/
. 
. /* Univariable model */ 
. 
. *mi estimate, dots eform: stcox i.exposure, nolog 
. *eform doesnt allow for lincom to build tables. use post
. mi estimate, dots post: stcox i.exposure, nolog

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Cox regression: Breslow method for ties         Number of obs     =    194,637
                                                Average RVI       =     0.0000
                                                Largest FMI       =     0.0000
DF adjustment:   Large sample                   DF:     min       =          .
                                                        avg       =          .
                                                        max       =          .
Model F test:       Equal FMI                   F(   1,      .)   =       3.88
Within VCE type:          OIM                   Prob > F          =     0.0488

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |  -.2521586   .1279928    -1.97   0.049      -.50302   -.0012973
------------------------------------------------------------------------------

. estimates save $Tempdir/univar_mi, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/univar_mi.ster sav
> ed

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_univar
> _mi_$outcome", replace) idstr("parmest_univar_mi_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_univar_mi_
> onscoviddeath.dta saved

. 
. 
. /* Multivariable models */ 
. 
. * Age and Sex 
. * Age fit as spline 
. 
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Cox regression: Breslow method for ties         Number of obs     =    194,637
                                                Average RVI       =     0.0000
                                                Largest FMI       =     0.0000
DF adjustment:   Large sample                   DF:     min       =          .
                                                        avg       =          .
                                                        max       =          .
Model F test:       Equal FMI                   F(   5,      .)   =     104.60
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0809107   .1289432     0.63   0.530    -.1718134    .3336348
      1.male |   .3804129   .0884145     4.30   0.000     .2071236    .5537023
        age1 |     .04971   .0358848     1.39   0.166    -.0206229     .120043
        age2 |    .084862   .0523668     1.62   0.105    -.0177749     .187499
        age3 |  -.3484382   .1997572    -1.74   0.081    -.7399551    .0430786
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar1_mi, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/multivar1_mi.ster 
> saved

. 
. 
. * DAG adjusted (age, sex, geographic region, other immunosuppressives (will i
> nclude biologics when we have them))  
.         *Note: ethnicity missing for ~20-25%. will model ethnicity in several
>  ways in separate do file
. 
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 i.ethnicity i.
> dmard_pc i.oral_prednisolone, strata(stp population)                         
>       

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =    194,637
                                                Average RVI       =     0.1599
                                                Largest FMI       =     0.4384
DF adjustment:   Large sample                   DF:     min       =      51.73
                                                        avg       =   3.77e+09
                                                        max       =   2.68e+10
Model F test:       Equal FMI                   F(  11, 4831.7)   =      49.26
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0283397   .1302937     0.22   0.828    -.2270311    .2837106
      1.male |   .3826089   .0887484     4.31   0.000     .2086652    .5565526
        age1 |    .053117   .0362263     1.47   0.143    -.0178853    .1241193
        age2 |    .072184    .052739     1.37   0.171    -.0311825    .1755506
        age3 |  -.2900467   .2011374    -1.44   0.149    -.6842688    .1041753
             |
   ethnicity |
South Asian  |   -.076219   .2213257    -0.34   0.731    -.5113642    .3589261
      Black  |   .1931052   .3755969     0.51   0.608    -.5509164    .9371268
      Mixed  |   .5113513   .6038465     0.85   0.401    -.7005083    1.723211
      Other  |  -.3388665   .7019454    -0.48   0.631    -1.735878    1.058145
             |
  1.dmard_pc |  -.0689477   .0922184    -0.75   0.455    -.2496924     .111797
1.oral_pr~ne |   .9021131    .088493    10.19   0.000       .72867    1.075556
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar2_mi, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/multivar2_mi.ster 
> saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar2_mi_$outcome", replace) idstr("parmest_multivar2_mi_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_multivar2_
> mi_onscoviddeath.dta saved

. 
. * DAG+ other adjustments (NSAIDs, heart disease, lung disease, kidney disease
> , liver disease, BMI, hypertension, cancer, stroke, dementia, and respiratory
>  disease excl asthma (OCS capturing ashtma))
. 
. mi estimate, dots post: stcox i.exposure i.male age1 age2 age3 i.ethnicity i.
> dmard_pc i.oral_prednisolone i.nsaids i.chronic_cardiac_disease i.resp_excl_a
> sthma i.egfr_cat_nomiss i.chronic_liver_disease i.obese4cat i.hypertension i.
> cancer_ever i.neuro_conditions i.flu_vaccine i.imd i.diabcat i.smoke_nomiss, 
> strata(stp population)      

Imputations (10):
  .........10 done

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =    194,637
                                                Average RVI       =     0.0553
                                                Largest FMI       =     0.4441
DF adjustment:   Large sample                   DF:     min       =      50.43
                                                        avg       =   1.14e+10
                                                        max       =   3.26e+11
Model F test:       Equal FMI                   F(  33,105227.6)  =      22.61
Within VCE type:          OIM                   Prob > F          =     0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    exposure |
        HCQ  |   .0318605   .1305567     0.24   0.807    -.2240258    .2877469
      1.male |   .2320303   .0919276     2.52   0.012     .0518556    .4122051
        age1 |   .0509084   .0366819     1.39   0.165    -.0209868    .1228035
        age2 |   .0579264   .0534723     1.08   0.279    -.0468774    .1627301
        age3 |  -.2270178   .2039452    -1.11   0.266    -.6267431    .1727074
             |
   ethnicity |
South Asian  |   -.070481   .2259689    -0.31   0.755    -.5150094    .3740475
      Black  |   .1408785   .3770252     0.37   0.709    -.6059105    .8876675
      Mixed  |   .4356365   .6087737     0.72   0.478    -.7868649    1.658138
      Other  |  -.3317753   .7116828    -0.47   0.642    -1.750431     1.08688
             |
  1.dmard_pc |   .0358727    .093323     0.38   0.701     -.147037    .2187823
1.oral_pr~ne |    .766176   .0918122     8.35   0.000     .5862274    .9461246
    1.nsaids |   -.157464   .1647826    -0.96   0.339     -.480432     .165504
1.~c_disease |   .3626313   .0931649     3.89   0.000     .1800315    .5452311
1.resp_exc~a |   .2940326    .099407     2.96   0.003     .0991985    .4888667
             |
egfr_cat_n~s |
      30-59  |   .1466643   .1003677     1.46   0.144    -.0500527    .3433814
        <30  |   .7222683   .1991838     3.63   0.000     .3318751    1.112662
             |
1.~r_disease |   .2238908   .3208899     0.70   0.485    -.4050419    .8528235
             |
   obese4cat |
Obese I ..)  |    .022627   .1169937     0.19   0.847    -.2066765    .2519304
Obese II..)  |   .1682347   .1744723     0.96   0.335    -.1737247    .5101942
Obese II..)  |    .280086   .2540135     1.10   0.270    -.2177713    .7779433
             |
1.hyperten~n |   .0164474   .0977594     0.17   0.866    -.1751574    .2080523
1.cancer_e~r |   .2391938   .1078075     2.22   0.027      .027895    .4504926
1.neuro_co~s |   .5327553   .1096756     4.86   0.000     .3177952    .7477155
1.flu_vacc~e |  -.2132625   .1060474    -2.01   0.044    -.4211116   -.0054134
             |
         imd |
          2  |   .2762403   .1449974     1.91   0.057    -.0079494    .5604299
          3  |    .421088   .1435929     2.93   0.003     .1396511    .7025249
          4  |   .3572594   .1477412     2.42   0.016      .067692    .6468268
5 most de..  |   .4679255   .1504485     3.11   0.002     .1730517    .7627993
             |
     diabcat |
Controlle..  |   .0935133   .1154394     0.81   0.418    -.1327438    .3197705
Uncontrol..  |   .4185324   .1572445     2.66   0.008     .1103385    .7267263
Diabetes,..  |   .5668056   .2371336     2.39   0.017     .1020323    1.031579
             |
smoke_nomiss |
     Former  |   .3474982   .1039279     3.34   0.001     .1438028    .5511935
    Current  |   .1209152   .1837258     0.66   0.510     -.239181    .4810115
------------------------------------------------------------------------------

. estimates save $Tempdir/multivar3_mi, replace 
file E:\analyses\hydroxychloroquine-research/output/tempdata/multivar3_mi.ster 
> saved

. parmest, label eform format(estimate p lb ub) saving("$Tempdir/parmest_multiv
> ar3_mi_$outcome", replace) idstr("parmest_multivar3_mi_$outcome") 
file E:\analyses\hydroxychloroquine-research/output/tempdata/parmest_multivar3_
> mi_onscoviddeath.dta saved

. 
.  
. 
. 
. 
. 
. 
. 
. 
. 
. 
. /* Print table (should be same code as main models===========================
> =====================================*/ 
. 
. 
. /* Print table===============================================================
> =*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using $Tabfigdir/table9.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 9: Association between HCQ use and $tableoutc
> ome - IMPUTED ETHNICITY") _n

. file write tablecontent _tab ("N") _tab ("Univariable") _tab _tab ("Age/Sex A
> djusted") _tab _tab ///
>                                                 ("DAG Adjusted") _tab _tab ("
> Fully Adjusted") _tab _tab  _n

. file write tablecontent _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab (
> "95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                 
>    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         cou if exposure == 0 
  546,678

.         local rowdenom = r(N)

.         cou if exposure == 0 & $outcome == 1
  1,667

.         local pct = 100*(r(N)/`rowdenom') 

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab 
> _tab ("1.00 (ref)")  _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (comparator)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         cou if exposure == 1 
  101,239

.         local rowdenom = r(N)

.         cou if exposure == 1 & $outcome == 1
  290

.         local pct = 100*(r(N)/`rowdenom') 

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

. 
. /* Main Model */ 
. estimates use $Tempdir/univar_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7771215    .099466    -1.97   0.049     .6047017    .9987036
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar1_mi

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.084274   .1398098     0.63   0.530     .8421363    1.396033
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar2_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.028745    .134039     0.22   0.828      .796896    1.328049
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _tab 

. 
. estimates use $Tempdir/multivar3_mi 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.032373   .1347832     0.24   0.807     .7992945     1.33342
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab ("(") %4.2f (r(lb)) ("-") %4
> .2f (r(ub)) (")") _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\hydroxychloroquine-research/output/log\13_an_mi.log
  log type:  text
 closed on:  19 Aug 2020, 14:44:51
-------------------------------------------------------------------------------
